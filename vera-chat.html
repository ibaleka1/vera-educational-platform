<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with VERA - Your Nervous System Companion</title>
  <meta name="description" content="Real-time conversation with VERA AI for nervous system support">
  
  <!-- CSS -->
  <style>
    /* DEFENSIVE RULES APPLIED - SAFE ENCODING */
    :root {
      --primary-purple: #6B46C1;
      --dark-purple: #342E6C;
      --neural-blue: #00D4FF;
      --activation-pink: #FF6B9D;
      --balance-gold: #FFD700;
      --calm-green: #00FF88;
      --deep-navy: #0A0B1E;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
      min-height: 100vh;
      color: white;
    }

    .chat-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      margin-bottom: 1rem;
    }

    .vera-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--neural-blue), var(--activation-pink));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      position: relative;
      animation: pulse-ring 2s ease-in-out infinite;
    }

    @keyframes pulse-ring {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.3); 
      }
      50% { 
        box-shadow: 0 0 0 20px rgba(0, 212, 255, 0); 
      }
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 1rem;
      margin-bottom: 1rem;
      max-height: 60vh;
    }

    .message {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-bubble {
      max-width: 70%;
      padding: 1rem 1.25rem;
      border-radius: 1.25rem;
      position: relative;
    }

    .vera-message .message-bubble {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(107, 70, 193, 0.2));
      border: 1px solid rgba(0, 212, 255, 0.3);
    }

    .user-message .message-bubble {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .message-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--neural-blue), var(--activation-pink));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .chat-input-area {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1rem;
    }

    .input-container {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .mode-toggle {
      width: 44px;
      height: 44px;
      background: var(--primary-purple);
      border: none;
      border-radius: 0.75rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }

    .mode-toggle:hover {
      background: var(--neural-blue);
      transform: scale(1.05);
    }

    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 1.5rem;
      padding: 0.75rem 1.25rem;
      color: white;
      font-size: 1rem;
      outline: none;
    }

    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .send-button {
      width: 44px;
      height: 44px;
      background: var(--primary-purple);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-button:hover {
      background: var(--neural-blue);
      transform: scale(1.1);
    }

    .quick-responses {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .quick-btn {
      background: rgba(0, 212, 255, 0.2);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 1.25rem;
      padding: 0.5rem 1rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 44px;
      font-size: 0.875rem;
    }

    .quick-btn:hover {
      background: rgba(0, 212, 255, 0.3);
      transform: translateY(-2px);
    }

    .voice-indicator {
      display: none;
      align-items: center;
      gap: 0.5rem;
      color: var(--neural-blue);
      font-size: 0.875rem;
    }

    .voice-indicator.active {
      display: flex;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--neural-blue);
      border-radius: 50%;
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Mobile-first responsive */
    @media (max-width: 767px) {
      .chat-container {
        padding: 0.5rem;
      }
      
      .message-bubble {
        max-width: 85%;
      }
      
      .quick-responses {
        flex-direction: column;
      }
    }

    /* Tablet/iPad */
    @media (min-width: 768px) and (max-width: 1023px) {
      .chat-container {
        padding: 1.5rem;
      }
    }

    /* Laptop and Desktop */
    @media (min-width: 1024px) {
      .chat-messages {
        max-height: 65vh;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="vera-avatar">V</div>
      <div>
        <h1 style="font-size: 1.5rem; margin-bottom: 0.25rem;">VERA</h1>
        <p style="opacity: 0.8; font-size: 0.875rem;">Your Nervous System Companion</p>
      </div>
    </div>

    <!-- Messages Area -->
    <div class="chat-messages" id="chatMessages">
      <!-- VERA's introduction message -->
      <div class="message vera-message">
        <div class="message-icon">V</div>
        <div class="message-bubble">
          <p>Hello, I'm VERA, your nervous system companion. I'm here to support your wellbeing. You can type or use voice to talk with me.</p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
      <div class="input-container">
        <button class="mode-toggle" id="modeToggle" title="Toggle voice mode">
          <span id="modeIcon">⌨️</span>
        </button>
        <input 
          type="text" 
          class="chat-input" 
          id="messageInput"
          placeholder="Type your message..."
          maxlength="500"
        >
        <button class="send-button" id="sendButton">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
      </div>

      <!-- Voice indicator -->
      <div class="voice-indicator" id="voiceIndicator">
        <div class="pulse-dot"></div>
        <span>Listening...</span>
      </div>

      <!-- Quick response buttons -->
      <div class="quick-responses">
        <button class="quick-btn" data-message="I'm feeling anxious today">I'm feeling anxious today</button>
        <button class="quick-btn" data-message="My body feels tense">My body feels tense</button>
        <button class="quick-btn" data-message="I need grounding">I need grounding</button>
        <button class="quick-btn" data-message="Help me regulate">Help me regulate</button>
      </div>
    </div>
  </div>

  <script>
    // VERA Chat Implementation - ERROR-PROOF with try-catch
    class VERAChat {
      constructor() {
        this.messages = [];
        this.isVoiceMode = false;
        this.isListening = false;
        this.recognition = null;
        
        try {
          this.initializeElements();
          this.setupEventListeners();
          this.initializeVoiceRecognition();
        } catch (error) {
          console.error('VERA Chat initialization error:', error);
        }
      }

      initializeElements() {
        this.chatMessages = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendButton = document.getElementById('sendButton');
        this.modeToggle = document.getElementById('modeToggle');
        this.modeIcon = document.getElementById('modeIcon');
        this.voiceIndicator = document.getElementById('voiceIndicator');
      }

      setupEventListeners() {
        // Send button
        this.sendButton.addEventListener('click', () => this.handleSend());
        
        // Enter key to send
        this.messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.handleSend();
        });

        // Mode toggle
        this.modeToggle.addEventListener('click', () => this.toggleVoiceMode());

        // Quick response buttons
        document.querySelectorAll('.quick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const message = btn.getAttribute('data-message');
            this.sendMessage(message);
          });
        });
      }

      initializeVoiceRecognition() {
        try {
          if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.lang = 'en-US';

            this.recognition.onresult = (event) => {
              const transcript = event.results[0][0].transcript;
              this.messageInput.value = transcript;
              this.handleSend();
            };

            this.recognition.onend = () => {
              this.isListening = false;
              this.voiceIndicator.classList.remove('active');
            };

            this.recognition.onerror = (event) => {
              console.error('Voice recognition error:', event.error);
              this.isListening = false;
              this.voiceIndicator.classList.remove('active');
            };
          }
        } catch (error) {
          console.error('Voice recognition setup error:', error);
        }
      }

      toggleVoiceMode() {
        this.isVoiceMode = !this.isVoiceMode;
        
        if (this.isVoiceMode) {
          this.modeIcon.textContent = '🎤';
          this.messageInput.placeholder = 'Tap microphone to speak...';
          this.startListening();
        } else {
          this.modeIcon.textContent = '⌨️';
          this.messageInput.placeholder = 'Type your message...';
          this.stopListening();
        }
      }

      startListening() {
        if (this.recognition && !this.isListening) {
          try {
            this.recognition.start();
            this.isListening = true;
            this.voiceIndicator.classList.add('active');
          } catch (error) {
            console.error('Voice start error:', error);
          }
        }
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
          this.isListening = false;
          this.voiceIndicator.classList.remove('active');
        }
      }

      handleSend() {
        const message = this.messageInput.value.trim();
        if (message) {
          this.sendMessage(message);
          this.messageInput.value = '';
        }
      }

      async sendMessage(messageText) {
        try {
          // Add user message
          this.addMessage(messageText, 'user');
          
          // Get VERA response
          const response = await this.getVERAResponse(messageText);
          
          // Add VERA response with delay for natural feel
          setTimeout(() => {
            this.addMessage(response.text, 'vera');
          }, 800);
          
        } catch (error) {
          console.error('Send message error:', error);
          this.addMessage("I'm here for you. Let's try that again.", 'vera');
        }
      }

      addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        if (sender === 'vera') {
          messageDiv.innerHTML = `
            <div class="message-icon">V</div>
            <div class="message-bubble">
              <p>${text}</p>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="message-bubble">
              <p>${text}</p>
            </div>
          `;
        }
        
        this.chatMessages.appendChild(messageDiv);
        this.scrollToBottom();
      }

      async getVERAResponse(userMessage) {
        try {
          // Simulate VERA's intelligent responses
          const responses = this.generateVERAResponse(userMessage);
          return { text: responses };
        } catch (error) {
          return { text: "I sense you're reaching out. I'm here to support you through this moment." };
        }
      }

      generateVERAResponse(message) {
        const lowercaseMessage = message.toLowerCase();
        
        // Nervous system keywords and responses - SAFE TEXT ONLY
        if (lowercaseMessage.includes('anxious') || lowercaseMessage.includes('anxiety')) {
          return "I notice anxiety in your words. Your nervous system is trying to protect you. Let's breathe together - would you like me to guide you through a calming technique?";
        }
        
        if (lowercaseMessage.includes('tense') || lowercaseMessage.includes('tension')) {
          return "Tension is your body holding a story. Where do you feel this tension most? We can work together to help it release gently.";
        }
        
        if (lowercaseMessage.includes('stress') || lowercaseMessage.includes('stressed')) {
          return "Stress lives in your nervous system before your mind knows it. I can help you recognize these early signals and find your way back to calm.";
        }
        
        if (lowercaseMessage.includes('grounding') || lowercaseMessage.includes('ground')) {
          return "Grounding connects you back to safety. Feel your feet on the earth, your breath in your body. Would you like to try a grounding exercise?";
        }
        
        if (lowercaseMessage.includes('regulate') || lowercaseMessage.includes('regulation')) {
          return "Regulation is your nervous system's superpower. Together we can strengthen your ability to find balance. What does your body need right now?";
        }
        
        // Default empathetic responses
        const defaultResponses = [
          "I hear you. Your nervous system is wise - it's communicating something important. Tell me more about what you're experiencing.",
          "Thank you for sharing with me. Your body holds so much wisdom. What sensations are you noticing right now?",
          "I'm here to support you through this. Every feeling is information from your nervous system. What would help you feel more settled?",
          "Your nervous system is always working to keep you safe. Sometimes it needs gentle guidance to remember it's okay to relax. How can I help?"
        ];
        
        return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
      }

      scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      }
    }

    // Initialize VERA Chat when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      try {
        new VERAChat();
      } catch (error) {
        console.error('VERA Chat failed to initialize:', error);
      }
    });
  </script>
</body>
</html>